<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historique - Jen et ses Saints</title>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;600&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-header: #f8f9fa;
            --bg-container: #f1f3f4;
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --border-color: #e8eaed;
            --accent-blue: #0056D2;
            --win-color: #34a853;
            --loss-color: #ea4335;
            --draw-color: #f9ab00;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', 'Google Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            margin: 0;
        }

        .app-container {
            padding: 8px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .back-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: var(--bg-header);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            text-decoration: none;
            color: var(--text-primary);
        }

        .back-btn:hover {
            background: var(--border-color);
        }

        .header-content {
            flex: 1;
        }

        .header-title {
            font-family: 'Google Sans', sans-serif;
            font-size: 18px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .header-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        /* Tabs */
        .tabs-container {
            display: flex;
            gap: 0;
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            background: var(--bg-header);
        }

        .tab-btn {
            flex: 1;
            padding: 10px 8px;
            font-family: 'Google Sans', sans-serif;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .tab-btn.active {
            background: var(--accent-blue);
            color: white;
        }

        .tab-btn:not(.active):hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        /* Tab content */
        .tab-content {
            display: none;
            flex: 1;
            flex-direction: column;
        }

        .tab-content.active {
            display: flex;
        }

        /* Match buttons container */
        .matches-container {
            background: var(--bg-container);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 12px;
        }

        .matches-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .match-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Google Sans', sans-serif;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .match-btn:hover {
            border-color: var(--accent-blue);
            box-shadow: 0 2px 6px rgba(0, 86, 210, 0.15);
        }

        .match-btn.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        .match-btn-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .match-btn-indicator.win {
            background: var(--win-color);
        }

        .match-btn-indicator.loss {
            background: var(--loss-color);
        }

        .match-btn-indicator.draw {
            background: var(--draw-color);
        }

        .match-btn.active .match-btn-indicator {
            background: white;
        }

        .match-btn-score {
            font-size: 11px;
            opacity: 0.7;
            margin-left: 4px;
        }

        /* Match detail container */
        .match-detail-container {
            display: none;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .match-detail-container.active {
            display: block;
        }

        /* Detail header */
        .detail-header {
            padding: 12px;
            text-align: center;
            background: var(--bg-header);
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }

        .detail-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: var(--text-secondary);
            transition: background 0.2s;
        }

        .detail-close-btn:hover {
            background: var(--border-color);
        }

        .detail-result-icon {
            font-size: 32px;
            margin-bottom: 6px;
        }

        .detail-result-label {
            font-family: 'Google Sans', sans-serif;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .detail-result-label.win { color: var(--win-color); }
        .detail-result-label.loss { color: var(--loss-color); }
        .detail-result-label.draw { color: var(--draw-color); }

        /* Score int√©gr√© dans le header */
        .detail-header-score {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin: 10px 0;
            padding: 8px 0;
        }

        .detail-header-team {
            text-align: center;
            min-width: 90px;
        }

        .detail-header-team-name {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }

        .detail-header-team-score {
            font-family: 'Google Sans', sans-serif;
            font-size: 28px;
            font-weight: 700;
        }

        .detail-header-team-score.home-winner { color: var(--accent-blue); }
        .detail-header-team-score.home-loser { color: var(--text-primary); }
        .detail-header-team-score.away-winner { color: var(--loss-color); }
        .detail-header-team-score.away-loser { color: var(--text-primary); }

        .detail-header-sep {
            font-size: 18px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* D√©tail sets inline dans le header */
        .detail-header-sets {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .detail-header-set-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            background: white;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .detail-header-set-chip .set-label {
            color: var(--text-secondary);
        }

        .detail-header-set-chip .set-score {
            font-weight: 600;
        }

        .detail-header-set-chip .set-score.home-won {
            color: var(--accent-blue);
        }

        .detail-header-set-chip .set-score.home-lost {
            color: var(--text-primary);
        }

        .detail-header-set-chip .set-score.away-won {
            color: var(--loss-color);
        }

        .detail-header-set-chip .set-score.away-lost {
            color: var(--text-primary);
        }

        .detail-opponent {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .detail-meta {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin-top: 6px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .match-type-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
        }

        .match-type-badge.championnat {
            background: #e8f0fe;
            color: #1a73e8;
        }

        .match-type-badge.ginette {
            background: #fce8e6;
            color: #d93025;
        }

        /* Detail sections */
        .detail-section {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .detail-section:last-of-type {
            border-bottom: none;
        }

        .detail-section.stats-section {
            padding: 12px 0 0 0;
        }

        .detail-section-title {
            font-family: 'Google Sans', sans-serif;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        /* Set tabs for stats */
        .detail-set-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            overflow: hidden;
            background: var(--bg-header);
        }

        .detail-set-tab {
            flex: 1;
            padding: 6px 4px;
            font-family: 'Google Sans', sans-serif;
            font-size: 11px;
            font-weight: 500;
            color: var(--text-secondary);
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .detail-set-tab.active {
            background: var(--accent-blue);
            color: white;
        }

        .detail-set-tab:not(.active):hover {
            background: var(--border-color);
        }

        /* Stats team title */
        .stats-team-title {
            font-family: 'Google Sans', sans-serif;
            font-size: 12px;
            font-weight: 600;
            padding: 8px 12px 6px;
            margin-top: 12px;
            color: var(--text-primary);
        }

        .stats-team-title:first-of-type {
            margin-top: 0;
        }

        .stats-team-title.home {
            color: var(--accent-blue);
        }

        .stats-team-title.away {
            color: var(--loss-color);
        }

        /* Stats tables container */
        .stats-tables-container {
            display: flex;
            gap: 0;
            overflow-x: auto;
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
        }

        /* Player names column (sticky) */
        .stats-players-col {
            flex-shrink: 0;
            border-right: 2px solid var(--border-color);
            background: white;
            position: sticky;
            left: 0;
            z-index: 2;
        }

        .stats-players-col .player-header {
            padding: 4px 8px;
            font-family: 'Google Sans', sans-serif;
            font-size: 10px;
            font-weight: 600;
            color: var(--text-secondary);
            background: var(--bg-header);
            height: 24px;
            display: flex;
            align-items: center;
        }

        .stats-players-col .player-subheader {
            padding: 3px 8px;
            font-size: 8px;
            background: var(--bg-header);
            border-bottom: 1px solid var(--border-color);
            height: auto;
            min-height: 14px;
        }

        .stats-players-col .player-name {
            padding: 5px 8px;
            font-size: 10px;
            font-weight: 500;
            white-space: nowrap;
            border-bottom: 1px solid #f1f3f4;
        }

        .stats-players-col .player-name.total-row {
            font-weight: 600;
            background: var(--bg-header);
            border-top: 1px solid var(--border-color);
        }

        /* Individual stat table card */
        .stat-table-card {
            flex: 1;
            min-width: 0;
            border-left: 1px solid var(--border-color);
        }

        .stat-table-card:first-of-type {
            border-left: none;
        }

        .stat-table-header {
            padding: 4px 6px;
            font-family: 'Google Sans', sans-serif;
            font-size: 9px;
            font-weight: 600;
            text-align: center;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-table-header.service {
            background: #e3f2fd;
            color: #1565c0;
        }

        .stat-table-header.reception {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .stat-table-header.attack {
            background: #fff3e0;
            color: #e65100;
        }

        .stat-table-header.defense {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .stat-table-header.block {
            background: #fce4ec;
            color: #c2185b;
        }

        /* Stats table */
        .detail-stats-table {
            border-collapse: collapse;
            font-size: 10px;
            width: 100%;
        }

        .detail-stats-table thead th {
            font-family: 'Google Sans', sans-serif;
            font-weight: 600;
            color: var(--text-secondary);
            padding: 3px 4px;
            text-align: center;
            font-size: 8px;
            white-space: nowrap;
            background: var(--bg-header);
            border-bottom: 1px solid var(--border-color);
        }

        .detail-stats-table tbody td {
            padding: 5px 4px;
            text-align: center;
            border-bottom: 1px solid #f1f3f4;
            font-size: 10px;
            min-width: 24px;
        }

        .detail-stats-table tbody tr:last-child td {
            border-bottom: none;
        }

        .detail-stats-table .total-row td {
            font-weight: 600;
            border-top: 1px solid var(--border-color);
            background: var(--bg-header);
        }

        .detail-stats-table .positive {
            color: var(--win-color);
            font-weight: 600;
        }

        .detail-stats-table .negative {
            color: var(--loss-color);
            font-weight: 600;
        }

        .detail-stats-table .neutral {
            color: var(--text-secondary);
        }

        /* Detail actions */
        .detail-actions {
            padding: 12px;
            display: flex;
            gap: 8px;
            border-top: 1px solid var(--border-color);
        }

        .detail-action-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-family: 'Google Sans', sans-serif;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .detail-action-btn.delete-btn {
            background: #fce8e6;
            color: var(--loss-color);
        }

        .detail-action-btn.delete-btn:hover {
            background: #f8d7da;
        }

        /* Empty state */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 48px 16px;
            text-align: center;
            flex: 1;
        }

        .empty-state-icon {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
        }

        .empty-state-icon.stats {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            color: #34a853;
        }

        .empty-state-icon.visual {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            color: #1a73e8;
        }

        .empty-state-title {
            font-family: 'Google Sans', sans-serif;
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .empty-state-desc {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
            max-width: 260px;
        }

        .empty-state-action {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 20px;
            padding: 10px 20px;
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 8px;
            font-family: 'Google Sans', sans-serif;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
        }

        .empty-state-action:hover {
            background: #0047b3;
        }

        /* Timeline des s√©ries de points */
        .timeline-section {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .timeline-section-title {
            font-family: 'Google Sans', sans-serif;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .timeline-set {
            margin-bottom: 14px;
        }

        .timeline-set:last-child {
            margin-bottom: 0;
        }

        .timeline-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .timeline-set-label {
            font-family: 'Google Sans', sans-serif;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .timeline-set-score {
            font-family: 'Google Sans', sans-serif;
            font-size: 11px;
            font-weight: 600;
        }

        .tl-score-home { color: var(--accent-blue); }
        .tl-score-away { color: var(--loss-color); }
        .tl-score-lost { color: var(--text-secondary); }
        .tl-sep { color: var(--text-secondary); margin: 0 2px; }

        .timeline-chart {
            display: flex;
            align-items: stretch;
            gap: 4px;
            position: relative;
            overflow-x: auto;
            padding: 2px 0;
        }

        .timeline-chart::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            height: 2px;
            background: #333;
            transform: translateY(-1px);
            pointer-events: none;
            z-index: 0;
        }

        .timeline-run {
            display: flex;
            flex-direction: column;
            gap: 0;
            z-index: 1;
        }

        .timeline-row {
            display: flex;
            gap: 1px;
        }

        .tl-block {
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Google Sans', sans-serif;
            font-weight: 600;
            color: white;
            border-radius: 2px;
            z-index: 1;
        }

        .tl-block.home {
            background: var(--accent-blue);
        }

        .tl-block.away {
            background: var(--loss-color);
        }

        .tl-block.empty {
            background: transparent;
        }

        /* Footer */
        .footer {
            margin-top: auto;
            padding-top: 20px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <a href="index.html" class="back-btn">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                </svg>
            </a>
            <div class="header-content">
                <h1 class="header-title">Historique & Stats</h1>
                <p class="header-subtitle">Jen et ses Saints</p>
            </div>
        </header>

        <!-- Tabs -->
        <div class="tabs-container">
            <button class="tab-btn active" id="tabMatchStats" onclick="switchTab('matchStats')">Stats Matchs</button>
            <button class="tab-btn" id="tabYearStats" onclick="switchTab('yearStats')">Stats Ann√©e</button>
            <button class="tab-btn" id="tabSetsStats" onclick="switchTab('setsStats')">Sets jou√©s</button>
        </div>

        <!-- Tab 1: Stats Matchs -->
        <div class="tab-content active" id="contentMatchStats">
            <!-- Matches buttons container -->
            <div class="matches-container" id="matchesContainer" style="display: none;">
                <div class="matches-grid" id="matchesGrid"></div>
            </div>

            <!-- Match detail -->
            <div class="match-detail-container" id="matchDetailContainer">
                <div class="detail-header">
                    <button class="detail-close-btn" onclick="closeMatchDetail()">‚úï</button>
                    <div class="detail-result-icon" id="detailResultIcon">üèÜ</div>
                    <div class="detail-result-label" id="detailResultLabel">Victoire</div>

                    <!-- Score int√©gr√© -->
                    <div class="detail-header-score">
                        <div class="detail-header-team">
                            <div class="detail-header-team-name">Jen et ses Saints</div>
                            <div class="detail-header-team-score" id="detailHomeSets">0</div>
                        </div>
                        <div class="detail-header-sep">‚Äì</div>
                        <div class="detail-header-team">
                            <div class="detail-header-team-name" id="detailAwayName">Adversaire</div>
                            <div class="detail-header-team-score" id="detailAwaySets">0</div>
                        </div>
                    </div>

                    <!-- D√©tail des sets inline -->
                    <div class="detail-header-sets" id="detailHeaderSets"></div>

                    <div class="detail-opponent" id="detailOpponent">vs Adversaire</div>
                    <div class="detail-meta" id="detailMeta"></div>
                </div>

                <!-- Timeline des s√©ries de points -->
                <div class="timeline-section" id="timelineSection" style="display: none;">
                    <div class="timeline-section-title">S√©ries de points</div>
                    <div id="timelineContainer"></div>
                </div>

                <div class="detail-section stats-section">
                    <div class="detail-set-tabs" id="detailSetTabs" style="margin: 0 12px 10px;"></div>

                    <!-- Stats √©quipe domicile -->
                    <div class="stats-team-title home">Jen et ses Saints</div>
                    <div class="stats-tables-container" id="statsTablesContainerHome"></div>

                    <!-- Stats √©quipe adverse -->
                    <div class="stats-team-title away" id="statsAwayTitle">Adversaire</div>
                    <div class="stats-tables-container" id="statsTablesContainerAway"></div>
                </div>

                <div class="detail-actions">
                    <button class="detail-action-btn delete-btn" id="detailDeleteBtn">Supprimer ce match</button>
                </div>
            </div>

            <!-- Empty state -->
            <div class="empty-state" id="emptyStateMatchStats">
                <div class="empty-state-icon stats">
                    <svg width="32" height="32" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                    </svg>
                </div>
                <h3 class="empty-state-title">Aucun match enregistr√©</h3>
                <p class="empty-state-desc">Les statistiques de vos matchs appara√Ætront ici une fois que vous aurez termin√© votre premier match.</p>
                <a href="nouveau-match.html" class="empty-state-action">
                    <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                    D√©marrer un match
                </a>
            </div>
        </div>

        <!-- Tab 2: Stats Ann√©e -->
        <div class="tab-content" id="contentYearStats">
            <div class="empty-state">
                <div class="empty-state-icon visual">
                    <svg width="32" height="32" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM9 10H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm-8 4H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z"/>
                    </svg>
                </div>
                <h3 class="empty-state-title">Statistiques annuelles</h3>
                <p class="empty-state-desc">Les statistiques cumul√©es de la saison seront disponibles apr√®s vos premiers matchs.</p>
            </div>
        </div>

        <!-- Tab 3: Sets jou√©s -->
        <div class="tab-content" id="contentSetsStats">
            <div class="empty-state">
                <div class="empty-state-icon visual">
                    <svg width="32" height="32" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/>
                    </svg>
                </div>
                <h3 class="empty-state-title">Sets jou√©s</h3>
                <p class="empty-state-desc">L'analyse d√©taill√©e de tous vos sets sera disponible ici.</p>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            FSGT 4√ó4 ‚Ä¢ Saison 2025-2026
        </footer>
    </div>

    <script src="storage.js"></script>
    <script>
        // ==================== DONN√âES ====================
        let matchHistory = Storage.getAllMatches().filter(m => m.status === 'completed');
        let currentDetailMatch = null;
        let currentDetailSetFilter = 'all';
        let selectedMatchIndex = null;

        // ==================== TABS ====================
        function switchTab(tab) {
            document.getElementById('tabMatchStats').classList.toggle('active', tab === 'matchStats');
            document.getElementById('tabYearStats').classList.toggle('active', tab === 'yearStats');
            document.getElementById('tabSetsStats').classList.toggle('active', tab === 'setsStats');

            document.getElementById('contentMatchStats').classList.toggle('active', tab === 'matchStats');
            document.getElementById('contentYearStats').classList.toggle('active', tab === 'yearStats');
            document.getElementById('contentSetsStats').classList.toggle('active', tab === 'setsStats');
        }

        // ==================== RENDU MATCHS ====================
        function renderMatchHistory() {
            const matchesContainer = document.getElementById('matchesContainer');
            const matchesGrid = document.getElementById('matchesGrid');
            const emptyState = document.getElementById('emptyStateMatchStats');
            const detailContainer = document.getElementById('matchDetailContainer');

            if (matchHistory.length === 0) {
                emptyState.style.display = 'flex';
                matchesContainer.style.display = 'none';
                detailContainer.classList.remove('active');
                return;
            }

            emptyState.style.display = 'none';
            matchesContainer.style.display = 'block';

            const sorted = [...matchHistory].sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

            matchesGrid.innerHTML = sorted.map((match, index) => {
                const resultClass = match.result || 'draw';
                const setsDisplay = (match.setsWon !== undefined && match.setsLost !== undefined)
                    ? `${match.setsWon}-${match.setsLost}`
                    : '';
                const isActive = selectedMatchIndex === index;

                return `
                    <button class="match-btn ${isActive ? 'active' : ''}" onclick="selectMatch(${index})">
                        <span class="match-btn-indicator ${resultClass}"></span>
                        <span>${escapeHtml(match.opponent || 'Adversaire')}</span>
                        <span class="match-btn-score">${setsDisplay}</span>
                    </button>
                `;
            }).join('');
        }

        function selectMatch(index) {
            const sorted = [...matchHistory].sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            const match = sorted[index];
            if (!match) return;

            selectedMatchIndex = index;
            currentDetailMatch = match;
            currentDetailSetFilter = 'all';

            // Update button states
            document.querySelectorAll('.match-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });

            const isWin = match.result === 'win';
            const isLoss = match.result === 'loss';
            const opponent = match.opponent || 'Adversaire';

            // Header
            document.getElementById('detailResultIcon').textContent = isWin ? 'üèÜ' : (isLoss ? 'üòî' : 'ü§ù');
            const labelEl = document.getElementById('detailResultLabel');
            labelEl.textContent = isWin ? 'Victoire' : (isLoss ? 'D√©faite' : 'Match nul');
            labelEl.className = 'detail-result-label ' + (match.result || 'draw');
            document.getElementById('detailOpponent').textContent = 'vs ' + opponent;

            // Meta
            const matchDate = match.timestamp ? formatDate(match.timestamp) : '';
            const typeName = match.type === 'ginette' ? 'Ginette' : 'Championnat';
            document.getElementById('detailMeta').innerHTML =
                '<span class="match-type-badge ' + (match.type === 'ginette' ? 'ginette' : 'championnat') + '">' + typeName + '</span>' +
                '<span>‚Ä¢</span><span>' + matchDate + '</span>';

            // Score sets dans le header
            const homeSetsEl = document.getElementById('detailHomeSets');
            const awaySetsEl = document.getElementById('detailAwaySets');
            const homeWon = (match.setsWon || 0) > (match.setsLost || 0);
            homeSetsEl.textContent = match.setsWon || 0;
            awaySetsEl.textContent = match.setsLost || 0;
            homeSetsEl.className = 'detail-header-team-score ' + (homeWon ? 'home-winner' : 'home-loser');
            awaySetsEl.className = 'detail-header-team-score ' + (homeWon ? 'away-loser' : 'away-winner');
            document.getElementById('detailAwayName').textContent = opponent;

            // D√©tail sets inline dans le header
            renderHeaderSets(match);

            // Tabs pour stats
            renderDetailSetTabs(match);

            // Timeline des s√©ries de points
            renderTimeline(match);

            // Stats joueurs
            renderDetailStats(match, 'all');

            // Delete button
            document.getElementById('detailDeleteBtn').onclick = function() {
                if (confirm('Supprimer ce match ?\n' + opponent + ' (' + (match.setsWon || 0) + '-' + (match.setsLost || 0) + ')')) {
                    Storage.deleteMatch(match.id);
                    matchHistory = Storage.getAllMatches().filter(m => m.status === 'completed');
                    selectedMatchIndex = null;
                    currentDetailMatch = null;
                    renderMatchHistory();
                    document.getElementById('matchDetailContainer').classList.remove('active');
                }
            };

            document.getElementById('matchDetailContainer').classList.add('active');
        }

        function closeMatchDetail() {
            document.getElementById('matchDetailContainer').classList.remove('active');
            selectedMatchIndex = null;
            currentDetailMatch = null;
            document.querySelectorAll('.match-btn').forEach(btn => btn.classList.remove('active'));
        }

        // ==================== DETAIL RENDERING ====================
        function renderHeaderSets(match) {
            const container = document.getElementById('detailHeaderSets');
            if (!match.sets) { container.innerHTML = ''; return; }

            const completedSets = match.sets.filter(s => s.completed);
            container.innerHTML = completedSets.map((s, i) => {
                const h = s.finalHomeScore || 0;
                const a = s.finalAwayScore || 0;
                const homeWon = h > a;
                const isTieBreak = (i === 4);
                const label = isTieBreak ? 'TB' : 'S' + (i + 1);

                // Home: bleu si gagne, noir si perd
                // Away: rouge si gagne, noir si perd
                const homeClass = homeWon ? 'home-won' : 'home-lost';
                const awayClass = homeWon ? 'away-lost' : 'away-won';

                return '<span class="detail-header-set-chip">' +
                    '<span class="set-label">' + label + '</span>' +
                    '<span class="set-score ' + homeClass + '">' + h + '</span>' +
                    '<span class="set-label">-</span>' +
                    '<span class="set-score ' + awayClass + '">' + a + '</span>' +
                '</span>';
            }).join('');
        }

        function renderDetailSetTabs(match) {
            const container = document.getElementById('detailSetTabs');
            if (!match.sets) { container.innerHTML = ''; return; }

            const completedSets = match.sets.filter(s => s.completed);
            let html = '<button class="detail-set-tab active" onclick="switchDetailStats(\'all\')">Global</button>';
            completedSets.forEach((s, i) => {
                html += '<button class="detail-set-tab" onclick="switchDetailStats(' + i + ')">Set ' + (i + 1) + '</button>';
            });
            container.innerHTML = html;
        }

        function switchDetailStats(setFilter) {
            currentDetailSetFilter = setFilter;

            document.querySelectorAll('.detail-set-tab').forEach((tab, i) => {
                if (setFilter === 'all' && i === 0) tab.classList.add('active');
                else if (setFilter === i - 1) tab.classList.add('active');
                else tab.classList.remove('active');
            });

            renderDetailStats(currentDetailMatch, setFilter);
        }

        function renderDetailStats(match, setFilter) {
            const containerHome = document.getElementById('statsTablesContainerHome');
            const containerAway = document.getElementById('statsTablesContainerAway');
            const awayTitle = document.getElementById('statsAwayTitle');

            // Mettre √† jour le nom de l'adversaire
            awayTitle.textContent = match.opponent || 'Adversaire';

            if (!match.sets) {
                containerHome.innerHTML = '<div style="text-align:center;color:var(--text-secondary);padding:20px;">Aucune statistique disponible</div>';
                containerAway.innerHTML = '';
                return;
            }

            const completedSets = match.sets.filter(s => s.completed);
            const setsToUse = (setFilter === 'all') ? completedSets : [completedSets[setFilter]].filter(Boolean);

            // Helper pour g√©n√©rer une cellule
            function cell(val, cls) {
                return '<td class="' + (val > 0 ? cls : '') + '">' + (val || '-') + '</td>';
            }

            // Fonction pour agr√©ger les stats d'une √©quipe
            function aggregateStats(setsData, teamKey) {
                const playerTotals = {};
                setsData.forEach(s => {
                    if (!s.stats || !s.stats[teamKey]) return;
                    for (const [name, data] of Object.entries(s.stats[teamKey])) {
                        if (!playerTotals[name]) {
                            playerTotals[name] = {
                                service: { tot: 0, ace: 0, splus: 0, fser: 0, recSumAdv: 0, recCountAdv: 0 },
                                reception: { tot: 0, r4: 0, r3: 0, r2: 0, r1: 0, frec: 0 },
                                attack: { tot: 0, attplus: 0, attminus: 0, bp: 0, fatt: 0 },
                                defense: { tot: 0, defplus: 0, defminus: 0, fdef: 0 },
                                block: { tot: 0, blcplus: 0, blcminus: 0, fblc: 0 }
                            };
                        }
                        const t = playerTotals[name];

                        // Service
                        t.service.tot += (data.service?.tot || 0);
                        t.service.ace += (data.service?.ace || 0);
                        t.service.splus += (data.service?.splus || 0);
                        t.service.fser += (data.service?.fs || data.service?.fser || 0);
                        t.service.recSumAdv += (data.service?.recSumAdv || 0);
                        t.service.recCountAdv += (data.service?.recCountAdv || 0);

                        // R√©ception
                        t.reception.tot += (data.reception?.tot || 0);
                        t.reception.r4 += (data.reception?.r4 || 0);
                        t.reception.r3 += (data.reception?.r3 || 0);
                        t.reception.r2 += (data.reception?.r2 || 0);
                        t.reception.r1 += (data.reception?.r1 || 0);
                        t.reception.frec += (data.reception?.faute || data.reception?.frec || 0);

                        // Attaque
                        t.attack.tot += (data.attack?.tot || 0);
                        t.attack.attplus += (data.attack?.fd || data.attack?.attplus || 0);
                        t.attack.attminus += (data.attack?.attminus || 0);
                        t.attack.bp += (data.attack?.bp || 0);
                        t.attack.fatt += (data.attack?.fatt || 0);

                        // D√©fense
                        t.defense.tot += (data.defense?.tot || 0);
                        t.defense.defplus += (data.defense?.defplus || 0);
                        t.defense.defminus += (data.defense?.defminus || 0);
                        t.defense.fdef += (data.defense?.fdef || 0);

                        // Bloc
                        t.block.tot += (data.block?.tot || 0);
                        t.block.blcplus += (data.block?.bl || data.block?.blcplus || 0);
                        t.block.blcminus += (data.block?.blcminus || 0);
                        t.block.fblc += (data.block?.fblc || 0);
                    }
                });
                return playerTotals;
            }

            // Fonction pour g√©n√©rer le HTML d'une √©quipe
            function generateStatsHTML(playerTotals) {
                const players = Object.keys(playerTotals);
                if (players.length === 0) {
                    return '<div style="text-align:center;color:var(--text-secondary);padding:20px;">Aucune statistique pour cette s√©lection</div>';
                }

                // Calcul des totaux
                const totals = {
                    service: { tot: 0, ace: 0, splus: 0, fser: 0, recSumAdv: 0, recCountAdv: 0 },
                    reception: { tot: 0, r4: 0, r3: 0, r2: 0, r1: 0, frec: 0 },
                    attack: { tot: 0, attplus: 0, attminus: 0, bp: 0, fatt: 0 },
                    defense: { tot: 0, defplus: 0, defminus: 0, fdef: 0 },
                    block: { tot: 0, blcplus: 0, blcminus: 0, fblc: 0 }
                };

                players.forEach(name => {
                    const p = playerTotals[name];
                    totals.service.tot += p.service.tot;
                    totals.service.ace += p.service.ace;
                    totals.service.splus += p.service.splus;
                    totals.service.fser += p.service.fser;
                    totals.service.recSumAdv += p.service.recSumAdv;
                    totals.service.recCountAdv += p.service.recCountAdv;
                    totals.reception.tot += p.reception.tot;
                    totals.reception.r4 += p.reception.r4;
                    totals.reception.r3 += p.reception.r3;
                    totals.reception.r2 += p.reception.r2;
                    totals.reception.r1 += p.reception.r1;
                    totals.reception.frec += p.reception.frec;
                    totals.attack.tot += p.attack.tot;
                    totals.attack.attplus += p.attack.attplus;
                    totals.attack.attminus += p.attack.attminus;
                    totals.attack.bp += p.attack.bp;
                    totals.attack.fatt += p.attack.fatt;
                    totals.defense.tot += p.defense.tot;
                    totals.defense.defplus += p.defense.defplus;
                    totals.defense.defminus += p.defense.defminus;
                    totals.defense.fdef += p.defense.fdef;
                    totals.block.tot += p.block.tot;
                    totals.block.blcplus += p.block.blcplus;
                    totals.block.blcminus += p.block.blcminus;
                    totals.block.fblc += p.block.fblc;
                });

                let html = '';

                // ===== COLONNE DES NOMS =====
                html += '<div class="stats-players-col">' +
                    '<div class="player-header">Joueur</div>' +
                    '<div class="player-subheader"></div>';
                players.forEach(name => {
                    html += '<div class="player-name">' + escapeHtml(name) + '</div>';
                });
                html += '<div class="player-name total-row">Total</div></div>';

                // Helper pour calculer la moyenne service (Moy)
                function srvMoy(p) {
                    const count = p.service.recCountAdv + p.service.ace;
                    if (count === 0) return '-';
                    const moy = p.service.recSumAdv / count;
                    return moy.toFixed(1);
                }
                function srvMoyClass(p) {
                    const count = p.service.recCountAdv + p.service.ace;
                    if (count === 0) return '';
                    const moy = p.service.recSumAdv / count;
                    if (moy <= 1.5) return 'positive';
                    if (moy >= 3.0) return 'negative';
                    return '';
                }

                // ===== SERVICE =====
                html += '<div class="stat-table-card">' +
                    '<div class="stat-table-header service">Service</div>' +
                    '<table class="detail-stats-table"><thead><tr>' +
                    '<th>Tot</th><th>Ace</th><th>S+</th><th>FS</th><th>Moy</th>' +
                    '</tr></thead><tbody>';
                players.forEach(name => {
                    const p = playerTotals[name];
                    html += '<tr>' +
                        '<td>' + (p.service.tot || '-') + '</td>' +
                        cell(p.service.ace, 'positive') +
                        cell(p.service.splus, 'positive') +
                        cell(p.service.fser, 'negative') +
                        '<td class="' + srvMoyClass(p) + '">' + srvMoy(p) + '</td>' +
                    '</tr>';
                });
                html += '<tr class="total-row">' +
                    '<td>' + (totals.service.tot || '-') + '</td>' +
                    cell(totals.service.ace, 'positive') +
                    cell(totals.service.splus, 'positive') +
                    cell(totals.service.fser, 'negative') +
                    '<td class="' + srvMoyClass({ service: totals.service }) + '">' + srvMoy({ service: totals.service }) + '</td>' +
                '</tr></tbody></table></div>';

                // ===== R√âCEPTION =====
                html += '<div class="stat-table-card">' +
                    '<div class="stat-table-header reception">R√©ception</div>' +
                    '<table class="detail-stats-table"><thead><tr>' +
                    '<th>Tot</th><th>R4</th><th>R3</th><th>R2</th><th>R1</th><th>FR</th>' +
                    '</tr></thead><tbody>';
                players.forEach(name => {
                    const p = playerTotals[name];
                    html += '<tr>' +
                        '<td>' + (p.reception.tot || '-') + '</td>' +
                        cell(p.reception.r4, 'positive') +
                        cell(p.reception.r3, 'positive') +
                        cell(p.reception.r2, 'neutral') +
                        cell(p.reception.r1, 'negative') +
                        cell(p.reception.frec, 'negative') +
                    '</tr>';
                });
                html += '<tr class="total-row">' +
                    '<td>' + (totals.reception.tot || '-') + '</td>' +
                    cell(totals.reception.r4, 'positive') +
                    cell(totals.reception.r3, 'positive') +
                    cell(totals.reception.r2, 'neutral') +
                    cell(totals.reception.r1, 'negative') +
                    cell(totals.reception.frec, 'negative') +
                '</tr></tbody></table></div>';

                // ===== ATTAQUE =====
                html += '<div class="stat-table-card">' +
                    '<div class="stat-table-header attack">Attaque</div>' +
                    '<table class="detail-stats-table"><thead><tr>' +
                    '<th>Tot</th><th>A+</th><th>A-</th><th>BP</th><th>FA</th>' +
                    '</tr></thead><tbody>';
                players.forEach(name => {
                    const p = playerTotals[name];
                    html += '<tr>' +
                        '<td>' + (p.attack.tot || '-') + '</td>' +
                        cell(p.attack.attplus, 'positive') +
                        cell(p.attack.attminus, 'neutral') +
                        cell(p.attack.bp, 'negative') +
                        cell(p.attack.fatt, 'negative') +
                    '</tr>';
                });
                html += '<tr class="total-row">' +
                    '<td>' + (totals.attack.tot || '-') + '</td>' +
                    cell(totals.attack.attplus, 'positive') +
                    cell(totals.attack.attminus, 'neutral') +
                    cell(totals.attack.bp, 'negative') +
                    cell(totals.attack.fatt, 'negative') +
                '</tr></tbody></table></div>';

                // ===== D√âFENSE =====
                html += '<div class="stat-table-card">' +
                    '<div class="stat-table-header defense">D√©fense</div>' +
                    '<table class="detail-stats-table"><thead><tr>' +
                    '<th>Tot</th><th>D+</th><th>D-</th><th>FD</th>' +
                    '</tr></thead><tbody>';
                players.forEach(name => {
                    const p = playerTotals[name];
                    html += '<tr>' +
                        '<td>' + (p.defense.tot || '-') + '</td>' +
                        cell(p.defense.defplus, 'positive') +
                        cell(p.defense.defminus, 'neutral') +
                        cell(p.defense.fdef, 'negative') +
                    '</tr>';
                });
                html += '<tr class="total-row">' +
                    '<td>' + (totals.defense.tot || '-') + '</td>' +
                    cell(totals.defense.defplus, 'positive') +
                    cell(totals.defense.defminus, 'neutral') +
                    cell(totals.defense.fdef, 'negative') +
                '</tr></tbody></table></div>';

                // ===== BLOC =====
                html += '<div class="stat-table-card">' +
                    '<div class="stat-table-header block">Bloc</div>' +
                    '<table class="detail-stats-table"><thead><tr>' +
                    '<th>Tot</th><th>B+</th><th>B-</th><th>FB</th>' +
                    '</tr></thead><tbody>';
                players.forEach(name => {
                    const p = playerTotals[name];
                    html += '<tr>' +
                        '<td>' + (p.block.tot || '-') + '</td>' +
                        cell(p.block.blcplus, 'positive') +
                        cell(p.block.blcminus, 'neutral') +
                        cell(p.block.fblc, 'negative') +
                    '</tr>';
                });
                html += '<tr class="total-row">' +
                    '<td>' + (totals.block.tot || '-') + '</td>' +
                    cell(totals.block.blcplus, 'positive') +
                    cell(totals.block.blcminus, 'neutral') +
                    cell(totals.block.fblc, 'negative') +
                '</tr></tbody></table></div>';

                return html;
            }

            // G√©n√©rer les stats pour l'√©quipe domicile
            const homeTotals = aggregateStats(setsToUse, 'home');
            containerHome.innerHTML = generateStatsHTML(homeTotals);

            // G√©n√©rer les stats pour l'√©quipe adverse
            const awayTotals = aggregateStats(setsToUse, 'away');
            containerAway.innerHTML = generateStatsHTML(awayTotals);
        }

        // ==================== TIMELINE ====================

        function buildTimelineData(set) {
            const points = set.points || [];
            if (points.length === 0) return [];

            const initialHome = set.initialHomeScore || 0;
            const initialAway = set.initialAwayScore || 0;
            const runs = [];
            let currentRun = null;

            for (let i = 0; i < points.length; i++) {
                const pt = points[i];
                const prevHome = i > 0 ? points[i - 1].homeScore : initialHome;
                const scorer = pt.homeScore > prevHome ? 'home' : 'away';
                const teamScore = scorer === 'home' ? pt.homeScore : pt.awayScore;

                if (currentRun && currentRun.team === scorer) {
                    currentRun.points.push({ teamScore });
                } else {
                    currentRun = { team: scorer, points: [{ teamScore }] };
                    runs.push(currentRun);
                }
            }
            return runs;
        }

        function computeBlockSize(totalPoints, runsCount) {
            const availableWidth = 556;
            const gapWidth = Math.max(0, runsCount - 1) * 4;
            const internalGaps = totalPoints - runsCount;
            const blockWidth = Math.floor((availableWidth - gapWidth - internalGaps) / totalPoints);
            return Math.max(8, Math.min(20, blockWidth));
        }

        function renderTimeline(match) {
            const container = document.getElementById('timelineContainer');
            const section = document.getElementById('timelineSection');

            if (!match.sets) { section.style.display = 'none'; return; }

            const completedSets = match.sets.filter(s => s.completed);
            if (completedSets.length === 0) { section.style.display = 'none'; return; }

            // V√©rifier qu'au moins un set a des points
            const hasPoints = completedSets.some(s => s.points && s.points.length > 0);
            if (!hasPoints) { section.style.display = 'none'; return; }

            section.style.display = 'block';
            let html = '';

            completedSets.forEach(function(set, i) {
                const runs = buildTimelineData(set);
                if (runs.length === 0) return;

                const totalPoints = runs.reduce(function(sum, r) { return sum + r.points.length; }, 0);
                const blockSize = computeBlockSize(totalPoints, runs.length);
                const fontSize = blockSize >= 14 ? 9 : (blockSize >= 10 ? 7 : 0);
                const blockHeight = 20;

                const homeScore = set.finalHomeScore || set.homeScore || 0;
                const awayScore = set.finalAwayScore || set.awayScore || 0;
                const homeWon = homeScore > awayScore;
                const label = i === 4 ? 'Tie-break' : 'Set ' + (i + 1);

                html += '<div class="timeline-set">';
                html += '<div class="timeline-header">';
                html += '<span class="timeline-set-label">' + label + '</span>';
                html += '<span class="timeline-set-score">';
                html += '<span class="' + (homeWon ? 'tl-score-home' : 'tl-score-lost') + '">' + homeScore + '</span>';
                html += '<span class="tl-sep">-</span>';
                html += '<span class="' + (homeWon ? 'tl-score-lost' : 'tl-score-away') + '">' + awayScore + '</span>';
                html += '</span></div>';

                html += '<div class="timeline-chart">';
                runs.forEach(function(run) {
                    html += '<div class="timeline-run">';
                    // Top row (home)
                    html += '<div class="timeline-row">';
                    run.points.forEach(function(pt) {
                        if (run.team === 'home') {
                            html += '<div class="tl-block home" style="width:' + blockSize + 'px;height:' + blockHeight + 'px;font-size:' + fontSize + 'px;">' + (fontSize > 0 ? pt.teamScore : '') + '</div>';
                        } else {
                            html += '<div class="tl-block empty" style="width:' + blockSize + 'px;height:' + blockHeight + 'px;"></div>';
                        }
                    });
                    html += '</div>';
                    // Bottom row (away)
                    html += '<div class="timeline-row">';
                    run.points.forEach(function(pt) {
                        if (run.team === 'away') {
                            html += '<div class="tl-block away" style="width:' + blockSize + 'px;height:' + blockHeight + 'px;font-size:' + fontSize + 'px;">' + (fontSize > 0 ? pt.teamScore : '') + '</div>';
                        } else {
                            html += '<div class="tl-block empty" style="width:' + blockSize + 'px;height:' + blockHeight + 'px;"></div>';
                        }
                    });
                    html += '</div>';
                    html += '</div>';
                });
                html += '</div></div>';
            });

            container.innerHTML = html;
        }

        // ==================== UTILS ====================
        function formatDate(timestamp) {
            const d = new Date(timestamp);
            const options = { day: 'numeric', month: 'short', year: 'numeric' };
            return d.toLocaleDateString('fr-FR', options);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==================== INIT ====================
        renderMatchHistory();

        // Ouvrir automatiquement un match si pass√© en param√®tre URL
        (function() {
            const params = new URLSearchParams(window.location.search);
            const matchId = params.get('match');
            if (matchId) {
                const sorted = [...matchHistory].sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                const index = sorted.findIndex(m => m.id === matchId);
                if (index >= 0) {
                    selectMatch(index);
                }
                window.history.replaceState({}, '', window.location.pathname);
            }
        })();
    </script>
</body>
</html>
